#!/bin/bash
#
# claude-setup v0.1
# Setup Claude Code infrastructure with framework detection
#
# Usage:
#   ./claude-setup              # Interactive mode
#   ./claude-setup --force      # Overwrite existing .claude
#   ./claude-setup --yes        # Auto-detect, no prompts
#   ./claude-setup --help       # Show help
#

set -e  # Exit on error

VERSION="0.2.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Flags
FORCE_MODE=false
YES_MODE=false

# Parse arguments
for arg in "$@"; do
    case $arg in
        --force|-f)
            FORCE_MODE=true
            shift
            ;;
        --yes|-y)
            YES_MODE=true
            shift
            ;;
        --help|-h)
            echo "claude-setup v$VERSION"
            echo ""
            echo "Setup Claude Code infrastructure with framework detection"
            echo ""
            echo "Usage:"
            echo "  claude-setup              Interactive mode with detection"
            echo "  claude-setup --force      Overwrite existing .claude directory"
            echo "  claude-setup --yes        Auto-detect, no prompts"
            echo "  claude-setup --help       Show this help"
            echo ""
            exit 0
            ;;
        *)
            echo "Unknown option: $arg"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Determine script directory (handles npm global install and symlinks)
SOURCE="${BASH_SOURCE[0]}"
# Resolve symlinks
while [ -L "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

# Check if running from npm install or from repo
if [ -d "$SCRIPT_DIR/cli/core" ]; then
    # Running from repo root
    TEMPLATE_DIR="$SCRIPT_DIR/cli"
elif [ -d "$SCRIPT_DIR/core" ]; then
    # Running from npm install (shouldn't happen, but keep as fallback)
    TEMPLATE_DIR="$SCRIPT_DIR"
else
    echo -e "${RED}Error: Cannot find core templates directory${NC}"
    echo "Looked in: $SCRIPT_DIR/cli/core and $SCRIPT_DIR/core"
    exit 1
fi

PROJECT_DIR=$(pwd)

# Header
echo ""
echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${BLUE}â”‚  Claude Code Setup v$VERSION            â”‚${NC}"
echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

# Step 1: Check if .claude exists
if [ -d ".claude" ]; then
    if [ "$FORCE_MODE" = true ]; then
        echo -e "${YELLOW}âš  Removing existing .claude directory (--force)${NC}"
        rm -rf .claude
    else
        echo -e "${YELLOW}âš  .claude directory already exists${NC}"
        if [ "$YES_MODE" = false ]; then
            read -p "Overwrite? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "Cancelled."
                exit 0
            fi
        else
            echo "Use --force to overwrite, or remove .claude manually"
            exit 1
        fi
        rm -rf .claude
    fi
fi

# Step 2: Detect available kits
echo -e "${BLUE}Detecting project frameworks...${NC}"
echo ""

# Helper function to get display name from kit.json (Bash 3 compatible)
get_display_name() {
    local kit_dir="$1"
    local kit_json="$kit_dir/kit.json"

    if command -v jq &> /dev/null; then
        jq -r '.displayName // .name' "$kit_json" 2>/dev/null || basename "$kit_dir"
    else
        basename "$kit_dir"
    fi
}

# Discover all available kits
declare -a ALL_KITS
declare -a DETECTED_KITS

if [ -d "$TEMPLATE_DIR/kits" ]; then
    for kit_dir in "$TEMPLATE_DIR/kits"/*; do
        if [ -d "$kit_dir" ] && [ -f "$kit_dir/kit.json" ]; then
            kit_name=$(basename "$kit_dir")
            ALL_KITS+=("$kit_name")
        fi
    done
fi

# Detect which kits match the project
for kit_name in "${ALL_KITS[@]}"; do
    kit_dir="$TEMPLATE_DIR/kits/$kit_name"
    kit_json="$kit_dir/kit.json"

    if [ -f "$kit_json" ]; then
        # Extract detect command
        if command -v jq &> /dev/null; then
            detect_cmd=$(jq -r '.detect.command // ""' "$kit_json" 2>/dev/null)
        else
            # Fallback: simple grep extraction
            detect_cmd=$(grep -o '"command"[[:space:]]*:[[:space:]]*"[^"]*"' "$kit_json" | sed 's/.*"\([^"]*\)".*/\1/' || echo "")
        fi

        # Run detection command
        if [ -n "$detect_cmd" ]; then
            if eval "$detect_cmd" 2>/dev/null; then
                DETECTED_KITS+=("$kit_name")
                display_name=$(get_display_name "$kit_dir")
                echo -e "${GREEN}âœ“${NC} Detected: $display_name"
            fi
        fi
    fi
done

if [ ${#DETECTED_KITS[@]} -eq 0 ]; then
    echo -e "${YELLOW}â„¹${NC} No frameworks auto-detected"
fi

echo ""

# Step 3: Kit selection
declare -a KITS_TO_INSTALL

if [ "$YES_MODE" = true ]; then
    # Auto-install all detected kits
    KITS_TO_INSTALL=("${DETECTED_KITS[@]}")

    if [ ${#KITS_TO_INSTALL[@]} -gt 0 ]; then
        echo -e "${BLUE}Auto-installing detected kits:${NC}"
        for kit in "${KITS_TO_INSTALL[@]}"; do
            display_name=$(get_display_name "$TEMPLATE_DIR/kits/$kit")
            echo -e "  - $display_name"
        done
    else
        echo -e "${BLUE}Installing core infrastructure only${NC}"
    fi
else
    # Interactive selection
    if [ ${#DETECTED_KITS[@]} -gt 0 ]; then
        echo -e "${BLUE}Detected kits available:${NC}"

        for kit in "${DETECTED_KITS[@]}"; do
            display_name=$(get_display_name "$TEMPLATE_DIR/kits/$kit")
            read -p "Install $display_name kit? (Y/n): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Nn]$ ]]; then
                KITS_TO_INSTALL+=("$kit")
            fi
        done
    fi

    # Ask if user wants to see additional kits
    echo ""
    read -p "Install additional kits? (y/N): " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo ""
        echo -e "${BLUE}Additional kits available:${NC}"

        for kit in "${ALL_KITS[@]}"; do
            # Skip if already in detected kits
            if [[ " ${DETECTED_KITS[@]} " =~ " ${kit} " ]]; then
                continue
            fi

            display_name=$(get_display_name "$TEMPLATE_DIR/kits/$kit")
            read -p "Install $display_name kit? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                KITS_TO_INSTALL+=("$kit")
            fi
        done
    fi
fi

echo ""
echo -e "${BLUE}Installing infrastructure...${NC}"
echo ""

# Step 4: Create .claude directory structure
mkdir -p .claude/{skills,hooks,agents,commands}

# Step 5: Copy core infrastructure
echo -e "${GREEN}âœ“${NC} Creating .claude directory"

# Copy hooks
cp -r "$TEMPLATE_DIR/core/hooks/"* .claude/hooks/
chmod +x .claude/hooks/*.sh 2>/dev/null || true
echo -e "${GREEN}âœ“${NC} Installed core hooks (skill-activation-prompt, post-tool-use-tracker)"

# Copy skill-developer
cp -r "$TEMPLATE_DIR/core/skills/skill-developer" .claude/skills/
echo -e "${GREEN}âœ“${NC} Installed skill-developer"

# Copy core agents
cp "$TEMPLATE_DIR/core/agents/"*.md .claude/agents/ 2>/dev/null || true
echo -e "${GREEN}âœ“${NC} Installed core agents (6 files)"

# Copy core commands
cp "$TEMPLATE_DIR/core/commands/"*.md .claude/commands/ 2>/dev/null || true
echo -e "${GREEN}âœ“${NC} Installed slash commands (dev-docs)"

# Step 6: Install selected kits
INSTALLED_SKILLS=""

for kit in "${KITS_TO_INSTALL[@]}"; do
    kit_dir="$TEMPLATE_DIR/kits/$kit"

    if [ ! -d "$kit_dir" ]; then
        echo -e "${YELLOW}âš ${NC} Warning: Kit directory not found: $kit"
        continue
    fi

    # Install skills from kit
    if [ -d "$kit_dir/skills" ]; then
        for skill_dir in "$kit_dir/skills"/*; do
            if [ -d "$skill_dir" ]; then
                skill_name=$(basename "$skill_dir")
                cp -r "$skill_dir" .claude/skills/
                INSTALLED_SKILLS="$INSTALLED_SKILLS $skill_name"
            fi
        done
    fi

    # Install agents from kit
    if [ -d "$kit_dir/agents" ]; then
        cp "$kit_dir/agents/"*.md .claude/agents/ 2>/dev/null || true
    fi

    # Install commands from kit
    if [ -d "$kit_dir/commands" ]; then
        cp "$kit_dir/commands/"*.md .claude/commands/ 2>/dev/null || true
    fi

    display_name=$(get_display_name "$kit_dir")
    echo -e "${GREEN}âœ“${NC} Installed $display_name kit"
done

if [ ${#KITS_TO_INSTALL[@]} -eq 0 ]; then
    echo -e "${BLUE}No kits selected - core infrastructure only${NC}"
fi

# Step 7: Create settings.json
cat > .claude/settings.json << 'EOF'
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/skill-activation-prompt.sh"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Edit|MultiEdit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/post-tool-use-tracker.sh"
          }
        ]
      }
    ],
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/tsc-check.sh"
          },
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/trigger-build-resolver.sh"
          },
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/error-handling-reminder.sh"
          }
        ]
      }
    ]
  },
  "permissions": {
    "editPermissions": "auto-accept",
    "writePermissions": "auto-accept"
  }
}
EOF
echo -e "${GREEN}âœ“${NC} Created settings.json"

# Step 8: Create skill-rules.json
# Start with base structure
cat > .claude/skills/skill-rules.json << 'EOF'
{
  "version": "1.0",
  "description": "Skill activation triggers for Claude Code",
  "skills": {
    "skill-developer": {
      "type": "domain",
      "enforcement": "suggest",
      "priority": "high",
      "promptTriggers": {
        "keywords": ["skill", "create skill", "skill triggers", "skill-rules.json"]
      }
    }
  }
}
EOF

# Merge skill-rules fragments from installed kits
for kit in "${KITS_TO_INSTALL[@]}"; do
    kit_dir="$TEMPLATE_DIR/kits/$kit"

    # Look for fragments in each skill directory
    if [ -d "$kit_dir/skills" ]; then
        for skill_dir in "$kit_dir/skills"/*; do
            if [ -d "$skill_dir" ]; then
                fragment_file="$skill_dir/skill-rules-fragment.json"

                if [ -f "$fragment_file" ]; then
                    if command -v jq &> /dev/null; then
                        # Use jq to merge the fragment into skill-rules.json
                        # Fragment is structured as {"skill-name": {...}}, not {"skills": {...}}
                        jq -s '.[0] * {"skills": (.[0].skills + .[1])}' \
                            .claude/skills/skill-rules.json "$fragment_file" > .claude/skills/skill-rules.tmp.json
                        mv .claude/skills/skill-rules.tmp.json .claude/skills/skill-rules.json
                    else
                        echo -e "${YELLOW}âš ${NC} jq not found - skipping skill-rules merge for $(basename "$skill_dir")"
                        echo "   Install jq for automatic skill trigger configuration"
                    fi
                fi
            fi
        done
    fi
done

echo -e "${GREEN}âœ“${NC} Created skill-rules.json"

# Step 9: Install hook dependencies
echo ""
echo -e "${BLUE}Installing hook dependencies...${NC}"
cd .claude/hooks
if npm install --silent > /dev/null 2>&1; then
    echo -e "${GREEN}âœ“${NC} Hook dependencies installed"
else
    echo -e "${YELLOW}âš ${NC} Failed to install hook dependencies (you can run 'cd .claude/hooks && npm install' manually)"
fi
cd "$PROJECT_DIR"

# Step 10: Update .gitignore
if [ -f .gitignore ]; then
    if ! grep -q "# Claude Code" .gitignore; then
        echo "" >> .gitignore
        echo "# Claude Code" >> .gitignore
        echo ".claude/settings.local.json" >> .gitignore
        echo ".claude/hooks/node_modules/" >> .gitignore
        echo -e "${GREEN}âœ“${NC} Updated .gitignore"
    fi
else
    cat > .gitignore << 'EOF'
# Claude Code
.claude/settings.local.json
.claude/hooks/node_modules/
EOF
    echo -e "${GREEN}âœ“${NC} Created .gitignore"
fi

# Step 11: Summary
echo ""
echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${BLUE}â”‚  Setup Complete! ðŸŽ‰                     â”‚${NC}"
echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""
echo "Files created:"
echo "  .claude/hooks/           (2 essential hooks)"
echo "  .claude/skills/          (skill-developer$INSTALLED_SKILLS)"
echo "  .claude/agents/          ($(ls -1 .claude/agents/*.md 2>/dev/null | wc -l) agents)"
echo "  .claude/commands/        ($(ls -1 .claude/commands/*.md 2>/dev/null | wc -l) commands)"
echo "  .claude/settings.json"
echo "  .claude/skills/skill-rules.json"
echo ""
echo "Next steps:"
echo ""
echo "1. Test skill activation:"
echo ""

# Generate test examples based on installed kits
test_examples_shown=false

for kit in "${KITS_TO_INSTALL[@]}"; do
    case "$kit" in
        react)
            echo "   React skill:"
            echo "   - Edit a .tsx file or ask 'How do I create a React component?'"
            echo ""
            test_examples_shown=true
            ;;
        mui)
            echo "   MUI skill:"
            echo "   - Edit a component file or ask 'How do I style with MUI?'"
            echo ""
            test_examples_shown=true
            ;;
        nodejs)
            echo "   Node.js skill:"
            echo "   - Edit a service file or ask 'How do I create a service layer?'"
            echo ""
            test_examples_shown=true
            ;;
        express)
            echo "   Express skill:"
            echo "   - Edit a route file or ask 'How do I create an API endpoint?'"
            echo ""
            test_examples_shown=true
            ;;
        prisma)
            echo "   Prisma skill:"
            echo "   - Edit schema.prisma or ask 'How do I create a Prisma model?'"
            echo ""
            test_examples_shown=true
            ;;
        tanstack-query)
            echo "   TanStack Query skill:"
            echo "   - Ask 'How do I fetch data with TanStack Query?'"
            echo ""
            test_examples_shown=true
            ;;
        tanstack-router)
            echo "   TanStack Router skill:"
            echo "   - Ask 'How do I create a route with TanStack Router?'"
            echo ""
            test_examples_shown=true
            ;;
    esac
done

if [ "$test_examples_shown" = false ]; then
    echo "   Try editing files or asking Claude questions!"
    echo "   The skill-developer skill is always available."
    echo ""
fi
echo ""
echo "2. Review configuration:"
echo "   - .claude/settings.json (hook configuration)"
echo "   - .claude/skills/skill-rules.json (skill triggers)"
echo ""
echo "Documentation: https://github.com/your-org/claude-code-infrastructure-showcase"
echo ""
